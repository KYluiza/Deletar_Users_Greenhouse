!pip install --upgrade gspread pandas gspread_dataframe
from google.colab import drive
import os
import pandas as pd
import numpy as np
from google.colab import auth
from google.auth import default
import gspread
from gspread_dataframe import get_as_dataframe
from datetime import datetime, timedelta
import requests

# â€”â€”â€”â€”â€” AUTENTICAÃ‡ÃƒO GOOGLE â€”â€”â€”â€”â€”
auth.authenticate_user()
creds, _ = default()
gc = gspread.authorize(creds)

# â€”â€”â€”â€”â€” CONFIGURAÃ‡Ã•ES â€”â€”â€”â€”â€”
API_TOKEN = "COLOQUE_SEU_TOKEN"
ON_BEHALF_OF_ID = "COLOQUE_SEU_CÃ“DIGO"
GREENHOUSE_DISABLE_URL = "https://harvest.greenhouse.io/v2/users/disable"
URL_PLANILHA_DE_RESCISÃ•ES = "COLOQUE O LINK DA SUA PLANILHA"

# â€”â€”â€”â€”â€” ABERTURA DO DOCUMENTO â€”â€”â€”â€”â€”
spreadsheet = gc.open_by_url(URL_PLANILHA)

# â€”â€”â€”â€”â€” LISTAGEM DINÃ‚MICA DAS ABAS NO FORMATO MÃªs/25 â€”â€”â€”â€”â€”
todas_abas = [sheet.title for sheet in spreadsheet.worksheets()]
abas = [aba for aba in todas_abas if "/25" in aba and len(aba) == 6]

print("ğŸ” Abas selecionadas automaticamente:")
print(abas)

# â€”â€”â€”â€”â€” DATA DE HOJE â€”â€”â€”â€”â€”
hoje = datetime.now().date()

# â€”â€”â€”â€”â€” LOOP NAS ABAS â€”â€”â€”â€”â€”
for nome_aba in abas:
    try:
        worksheet = spreadsheet.worksheet(nome_aba)
        dados = worksheet.get_all_values()

        # Garante que tenha dados o suficiente (pelo menos cabeÃ§alho + 1 linha)
        if len(dados) < 3:
            print(f"âš ï¸ Aba '{nome_aba}' nÃ£o tem dados suficientes.")
            continue

        # Precisei usar a linha 2 (index 1) como cabeÃ§alho mas vocÃª pode usar a primeira com o cÃ³digo: df = pd.DataFrame(dados[1:], columns=dados[0])
        df = pd.DataFrame(dados[2:], columns=dados[1])
        df = df.dropna(subset=["E-mail Corporativo", "Data RescisÃ£o"], how='any')

        for _, row in df.iterrows():
            try:
                email = str(row["E-mail Corporativo"]).strip().lower()
                data_rescisao = pd.to_datetime(str(row["Data RescisÃ£o"]), dayfirst=True, errors="coerce")

                if pd.isna(data_rescisao):
                    continue

                # â€”â€”â€” REGRA: desabilita todo mundo que jÃ¡ foi desligado atÃ© hoje â€”â€”â€”
                if data_rescisao.date() <= hoje:
                    payload = { "user": { "email": email } }
                    headers = {
                        "Authorization": API_TOKEN,
                        "Content-Type": "application/json",
                        "On-Behalf-Of": ON_BEHALF_OF_ID
                    }
                    response = requests.patch(GREENHOUSE_DISABLE_URL, json=payload, headers=headers)

                    if response.status_code == 200:
                        print(f"âœ… {email} desabilitado (rescisÃ£o em {data_rescisao.date()})")
                    else:
                        print(f"âŒ Erro ao desabilitar {email} â€” {response.status_code} | {response.text}")

            except Exception as erro:
                print(f"Erro com a linha: {row} \n{erro}")

    except Exception as erro:
        print(f"âŒ Erro na aba '{nome_aba}': {erro}")
